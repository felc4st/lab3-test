
name: YCSB - Local Tests with Terraform


on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-and-benchmark:
    runs-on: ubuntu-latest

    steps:
    # 1. Отримуємо код
    - name: Checkout Code
      uses: actions/checkout@v3

    # 2. Налаштування середовищ
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Set up Java 11 (For YCSB)
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '11'

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_wrapper: false

    # 3. Встановлення залежностей Python
    - name: Install Python Deps
      run: pip install pytest requests

    # 4. ЗАПУСК ІНФРАСТРУКТУРИ
    - name: Terraform Apply
      working-directory: ./terraform/local
      run: |
        terraform init
        terraform apply -auto-approve

    - name: Wait for Cluster Readiness
      run: |
        echo "Waiting for shards to register..."
        # Цикл: 30 спроб з інтервалом 5 секунд
        for i in {1..30}; do
          # Пробуємо записати тестові дані для обох шардів (щоб переконатися, що обидва лідери тут)
          # "user1" -> Shard A, "user2" -> Shard B (імовірно)
          
          # Спочатку реєструємо таблицю (це безпечно робити багато разів)
          curl -s -X POST http://localhost:8000/tables -H "Content-Type: application/json" -d '{"name": "readiness_check"}' > /dev/null
          
          # Пробуємо записати
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8000/tables/readiness_check/records -H "Content-Type: application/json" -d '{"partition_key": "check", "value": {"status": "ok"}}')
          
          if [ "$HTTP_CODE" == "200" ]; then
            echo "System is READY! (Attempt $i)"
            exit 0
          fi
          
          echo "System not ready yet (Code: $HTTP_CODE). Retrying..."
          sleep 5
        done
        echo "System failed to start in time."
        exit 1



    # 7. ПІДГОТОВКА ТА ЗАПУСК YCSB
    - name: Prepare and Run YCSB
      run: |
        echo ">>> 1. Cloning YCSB (Stable Version 0.17.0) <<<"
        git clone --branch 0.17.0 https://github.com/brianfrankcooper/YCSB.git --depth 1
        cd YCSB
        
        echo ">>> 2. Installing CORE ONLY <<<"
        mvn -pl core -am clean install -DskipTests -Dmaven.javadoc.skip=true
        
        echo ">>> 3. Creating Module Structure (site.ycsb) <<<"
        mkdir -p labdb/src/main/java/site/ycsb/db
        sed 's/com.yahoo.ycsb/site.ycsb/g' ../tests/ycsb-driver/LabDBClient.java > labdb/src/main/java/site/ycsb/db/LabDBClient.java
        
        echo ">>> 4. Generating POM.xml (SAFE MODE) <<<"
        # Використовуємо echo замість cat <<EOF, щоб уникнути помилок відступів
        echo '<?xml version="1.0" encoding="UTF-8"?>' > labdb/pom.xml
        echo '<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">' >> labdb/pom.xml
        echo '    <modelVersion>4.0.0</modelVersion>' >> labdb/pom.xml
        echo '    <parent>' >> labdb/pom.xml
        echo '        <groupId>site.ycsb</groupId>' >> labdb/pom.xml
        echo '        <artifactId>root</artifactId>' >> labdb/pom.xml
        echo '        <version>0.17.0</version>' >> labdb/pom.xml
        echo '    </parent>' >> labdb/pom.xml
        echo '    <artifactId>labdb-binding</artifactId>' >> labdb/pom.xml
        echo '    <name>LabDB Binding</name>' >> labdb/pom.xml
        echo '    <dependencies>' >> labdb/pom.xml
        echo '        <dependency>' >> labdb/pom.xml
        echo '            <groupId>site.ycsb</groupId>' >> labdb/pom.xml
        echo '            <artifactId>core</artifactId>' >> labdb/pom.xml
        echo '            <version>0.17.0</version>' >> labdb/pom.xml
        echo '        </dependency>' >> labdb/pom.xml
        echo '    </dependencies>' >> labdb/pom.xml
        echo '</project>' >> labdb/pom.xml
        
        echo ">>> 5. Registering & Building LabDB <<<"
        sed -i '/<modules>/a <module>labdb</module>' pom.xml
        
        # Збираємо, ігноруючи стиль коду
        mvn -pl labdb package -DskipTests -Dcheckstyle.skip dependency:copy-dependencies
        
        echo ">>> 6. Preparing Classpath <<<"
        CP="labdb/target/labdb-binding-0.17.0.jar:labdb/target/dependency/*"
        
        echo ">>> 7. Running Benchmark <<<"
        
        echo "--- LOAD PHASE ---"
        java -cp "$CP" site.ycsb.Client -load -db site.ycsb.db.LabDBClient \
          -P workloads/workloada \
          -p labdb.url=http://localhost:8000 \
          -p recordcount=500 \
          -p threadcount=1

        echo "--- RUN PHASE ---"
        java -cp "$CP" site.ycsb.Client -t -db site.ycsb.db.LabDBClient \
          -P workloads/workloada \
          -p labdb.url=http://localhost:8000 \
          -p operationcount=1000 \
          -p threadcount=1
          
    # 8. ДЕБАГ (Виправлені імена контейнерів)
    - name: Show Docker Logs (Debug)
      if: always()
      run: |
        docker ps -a
        echo "=== COORDINATOR LOGS ==="
        docker logs coordinator
        echo "=== S1 LEADER LOGS ==="
        docker logs s1-leader
        echo "=== S2 LEADER LOGS ==="
        docker logs s2-leader
        # Не намагаємось читати старий shard-1

    # 9. ОЧИЩЕННЯ
    - name: Terraform Destroy
      if: always()
      working-directory: ./terraform/local
      run: terraform destroy -auto-approve
