
name: YCSB - Local Tests with Terraform


on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-and-benchmark:
    runs-on: ubuntu-latest

    steps:
    # 1. Отримуємо код
    - name: Checkout Code
      uses: actions/checkout@v3

    # 2. Налаштування середовищ
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Set up Java 11 (For YCSB)
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '11'

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_wrapper: false

    # 3. Встановлення залежностей Python
    - name: Install Python Deps
      run: pip install pytest requests

    # 4. ЗАПУСК ІНФРАСТРУКТУРИ
    - name: Terraform Apply
      working-directory: ./terraform/local
      run: |
        terraform init
        terraform apply -auto-approve

    # 5. Очікування (збільшено до 60с для надійності)
    - name: Wait for Cluster
      run: sleep 60



   # 7. ПІДГОТОВКА ТА ЗАПУСК YCSB
    - name: Prepare and Run YCSB
      run: |
        echo ">>> 1. Cloning YCSB (Stable Version 0.17.0) <<<"
        git clone --branch 0.17.0 https://github.com/brianfrankcooper/YCSB.git --depth 1
        cd YCSB
        
        echo ">>> 2. Installing ROOT POM locally <<<"
        # Спочатку встановлюємо кореневий проєкт, щоб Maven знав про нього
        mvn clean install -DskipTests -am
        
        echo ">>> 3. Creating Module Structure <<<"
        mkdir -p labdb/src/main/java/com/yahoo/ycsb/db
        cp ../tests/ycsb-driver/LabDBClient.java labdb/src/main/java/com/yahoo/ycsb/db/
        
        echo ">>> 4. Generating POM.xml <<<"
        cat <<EOF > labdb/pom.xml
        <?xml version="1.0" encoding="UTF-8"?>
        <project xmlns="http://maven.apache.org/POM/4.0.0"
                 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                 xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
            <modelVersion>4.0.0</modelVersion>
            <parent>
                <groupId>com.yahoo.ycsb</groupId>
                <artifactId>root</artifactId>
                <version>0.17.0</version>
            </parent>
            <artifactId>labdb-binding</artifactId>
            <name>LabDB Binding</name>
            <dependencies>
                <dependency>
                    <groupId>com.yahoo.ycsb</groupId>
                    <artifactId>core</artifactId>
                    <version>0.17.0</version>
                </dependency>
            </dependencies>
        </project>
        EOF
        
        echo ">>> 5. Registering & Building Module <<<"
        # Додаємо модуль
        sed -i '/<modules>/a <module>labdb</module>' pom.xml
        # Тепер збираємо, і оскільки ми зробили 'mvn install' на кроці 2, 
        # Maven знайде parent pom у локальному репозиторії (~/.m2)
        mvn -pl labdb -am package -DskipTests
        
        echo ">>> 6. Running Benchmark (JAVA DIRECTLY) <<<"
        # Замість глючного python скрипта, запускаємо Java напряму
        # Нам треба зібрати CLASSPATH з усіх JAR файлів
        
        # 1. Core YCSB jars
        CP="core/target/*:core/target/dependency/*"
        # 2. Наш LabDB jar
        CP="$CP:labdb/target/*:labdb/target/dependency/*"
        # 3. Slf4j (логінг)
        CP="$CP:core/target/dependency/slf4j-api-*.jar:core/target/dependency/slf4j-simple-*.jar"

        echo "Classpath: $CP"

        echo ">>> LOAD PHASE <<<"
        java -cp "$CP" com.yahoo.ycsb.Client -load -db com.yahoo.ycsb.db.LabDBClient \
          -P workloads/workloada \
          -p labdb.url=http://localhost:8000 \
          -p recordcount=500 \
          -p threadcount=2

        echo ">>> RUN PHASE <<<"
        java -cp "$CP" com.yahoo.ycsb.Client -t -db com.yahoo.ycsb.db.LabDBClient \
          -P workloads/workloada \
          -p labdb.url=http://localhost:8000 \
          -p operationcount=1000 \
          -p threadcount=4
    # 8. ДЕБАГ (Виправлені імена контейнерів)
    - name: Show Docker Logs (Debug)
      if: always()
      run: |
        docker ps -a
        echo "=== COORDINATOR LOGS ==="
        docker logs coordinator
        echo "=== S1 LEADER LOGS ==="
        docker logs s1-leader
        echo "=== S2 LEADER LOGS ==="
        docker logs s2-leader
        # Не намагаємось читати старий shard-1

    # 9. ОЧИЩЕННЯ
    - name: Terraform Destroy
      if: always()
      working-directory: ./terraform/local
      run: terraform destroy -auto-approve
